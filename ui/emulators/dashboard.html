<!DOCTYPE html>
<html lang="en">
<script>
    // @ts-check
</script>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emulators Dashboard</title>
  <!-- TODO: use internal paths (webpack?) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://unpkg.com/bulma-switch@2.0.0/dist/css/bulma-switch.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/solid.css"
    integrity="sha384-QokYePQSOwpBDuhlHOsX0ymF6R/vLk/UQVz3WHa6wygxI5oGTmDTv8wahFOSspdm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/fontawesome.css"
    integrity="sha384-vd1e11sR28tEK9YANUtpIOdjGW14pS87bUBuOIoBILVWLFnS+MCX9T6MMf0VdPGq" crossorigin="anonymous">
  <style>
    /** Terminal colors **/

    .terminal {
      color: var(--vscode-terminal-foreground);
      background-color: var(--vscode-terminal-background);
      font-family: monospace;
      font-size: 0.91em;
    }

    .terminal::selection {
      background-color: var(--vscode-terminal-selectionBackground);
    }


    .ansi-black-fg {
      color: var(--vscode-terminal-ansiBlack);
    }

    .ansi-black-bg {
      background-color: var(--vscode-terminal-ansiBlack);
    }

    .ansi-black-fg {
      color: var(--vscode-terminal-ansiBrightBlack);
    }

    .ansi-black-bg {
      background-color: var(--vscode-terminal-ansiBrightBlack);
    }

    .ansi-red-fg {
      color: var(--vscode-terminal-ansiRed);
    }

    .ansi-red-bg {
      background-color: var(--vscode-terminal-ansiRed);
    }

    .ansi-red-fg {
      color: var(--vscode-terminal-ansiBrightRed);
    }

    .ansi-red-bg {
      background-color: var(--vscode-terminal-ansiBrightRed);
    }

    .ansi-green-fg {
      color: var(--vscode-terminal-ansiGreen);
    }

    .ansi-green-bg {
      background-color: var(--vscode-terminal-ansiGreen);
    }

    .ansi-green-fg {
      color: var(--vscode-terminal-ansiBrightGreen);
    }

    .ansi-green-bg {
      background-color: var(--vscode-terminal-ansiBrightGreen);
    }

    .ansi-yellow-fg {
      color: var(--vscode-terminal-ansiYellow);
    }

    .ansi-yellow-bg {
      background-color: var(--vscode-terminal-ansiYellow);
    }

    .ansi-yellow-fg {
      color: var(--vscode-terminal-ansiBrightYellow);
    }

    .ansi-yellow-bg {
      background-color: var(--vscode-terminal-ansiBrightYellow);
    }

    .ansi-blue-fg {
      color: var(--vscode-terminal-ansiBlue);
    }

    .ansi-blue-bg {
      background-color: var(--vscode-terminal-ansiBlue);
    }

    .ansi-blue-fg {
      color: var(--vscode-terminal-ansiBrightBlue);
    }

    .ansi-blue-bg {
      background-color: var(--vscode-terminal-ansiBrightBlue);
    }

    .ansi-magenta-fg {
      color: var(--vscode-terminal-ansiMagenta);
    }

    .ansi-magenta-bg {
      background-color: var(--vscode-terminal-ansiMagenta);
    }

    .ansi-magenta-fg {
      color: var(--vscode-terminal-ansiBrightMagenta);
    }

    .ansi-magenta-bg {
      background-color: var(--vscode-terminal-ansiBrightMagenta);
    }

    .ansi-cyan-fg {
      color: var(--vscode-terminal-ansiCyan);
    }

    .ansi-cyan-bg {
      background-color: var(--vscode-terminal-ansiCyan);
    }

    .ansi-cyan-fg {
      color: var(--vscode-terminal-ansiBrightCyan);
    }

    .ansi-cyan-bg {
      background-color: var(--vscode-terminal-ansiBrightCyan);
    }

    .ansi-white-fg {
      color: var(--vscode-terminal-ansiWhite);
    }

    .ansi-white-bg {
      background-color: var(--vscode-terminal-ansiWhite);
    }

    .ansi-white-fg {
      color: var(--vscode-terminal-ansiBrightWhite);
    }

    .ansi-white-bg {
      background-color: var(--vscode-terminal-ansiBrightWhite);
    }
  </style>
  <style>
    :root {
      --shell-output-foreground: #AAAAAA;
      --shell-output-background: #1B1B1B;
    }

    html,
    body {
      height: 100%;
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
    }

    body>.super-container {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: 0 auto;
    }

    a {
      color: var(--vscode-textLink-foreground);
    }

    a:hover {
      color: var(--vscode-textLink-activeForeground);
      opacity: 0.9;
    }

    .button,
    .button[disabled] {
      background-color: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .button:not([disabled]):hover {
      background-color: var(--vscode-button-hoverBackground);
      border-color: var(--vscode-button-hoverBackground);
      color: var(--vscode-button-foreground);
    }

    .tabs ul {
      border-bottom-color: var(--vscode-editorGroupHeader-tabsBackground);
    }

    .tabs a {
      padding: .25em 1em;
    }

    .tabs li:not(.is-active) a {
      color: var(--vscode-foreground);
      background-color: var(--vscode-editorWidget-background);
      border-bottom-color: var(--vscode-editorGroupHeader-tabsBackground);
    }

    .tabs li.is-active a {
      color: var(--vscode-tab-activeForeground);
      background-color: var(--vscode-tab-activeBackground);
      border-bottom-color: var(--vscode-editor-background);
    }

    .tabs li:not(.is-active) a:hover {
      color: var(--vscode-tab-activeForeground);
    }

    .tab-content {
      display: none;
      padding-left: 0.6rem;

      /* TODO: fix this */
      height: 90%;
    }

    .tab-content.is-active {
      display: block;
    }

    .switch[type=checkbox].is-outlined:checked+label:before {
      border-color: var(--vscode-button-background);
    }

    .switch[type=checkbox].is-outlined:checked+label:after {
      background: var(--vscode-button-background);
    }

    .tabs,
    .tabs:not(:last-child) {
      margin-bottom: 0.75rem;
    }

    .box {
      padding: 1rem;
      /* padding: 1rem 1rem 1rem 0.5rem; */
      box-shadow: none;
    }

    .column.controls {
      flex: none;
    }

    .column.controls .box {
      background-color: var(--vscode-editorWidget-background);
      /* box-shadow: inset 0px 0px 0px 1px var(--vscode-editorWidget-border); */
    }

    .box:not(:last-child) {
      margin-bottom: 1.2rem;
    }

    .columns.bottom {
      height: 95%;
    }

    .tabs a,
    label.checkbox {
      color: var(--vscode-foreground);
    }

    .controls-box-label {
      color: var(--vscode-foreground);
      margin-top: -0.5em;
      font-weight: initial;
    }

    .running-status::after {
      content: 'stopped';
      font-family: monospace;
    }

    body.running .running-status::after {
      content: 'running';
    }

    body.stopping .running-status::after {
      content: 'stopping';
    }

    label.checkbox:hover {
      color: var(--vscode-tab-activeForeground);
    }

    .shell-output-box {
      height: 100%;
      padding-left: 0.5rem;
      border: 1px solid var(--vscode-editorWidget-background);
    }

    .shell-output .item {
      padding-left: 0.3rem;
    }

    .shell-output .item-stderr {
      box-shadow: -0.2rem 0 0 0 var(--vscode-editorError-foreground);
    }

    .top-controls.level {
      margin-bottom: 1rem !important;
    }

    .top-controls .field.has-addons select {
      border-top-left-radius: 0;
      border-bottom-left-radius: 0;
    }

    .top-controls .field .button,
    .top-controls .field select {
      /* font-size: 0.85rem; */
      color: var(--vscode-foreground);
      background-color: var(--vscode-editorWidget-background);
      border-color: var(--vscode-editorWidget-background);
    }

    .top-controls .select:not(.is-multiple):not(.is-loading)::after {
      border-color: var(--vscode-button-background);
    }

    .workspace-selector-field.hidden {
      visibility: hidden;
    }

    .table.logging-table {
      color: inherit;
      font-size: 0.9rem;
      background-color: inherit;
    }

    .table.logging-table th,
    .table.logging-table td {
      border: none;
      padding: .2em .4em;
    }

    .table.logging-table thead th,
    .table.logging-table thead td {
      color: inherit;
    }

    .table.is-hoverable tbody tr:not(.is-selected):hover {
      background-color: var(--vscode-editorWidget-background);
    }

    .tab-content--https-functions td.log-entry-cell-timestamp {
      min-width: 10rem;
    }

    .tab-content--https-functions td.log-entry-cell-type {
      min-width: 7rem;
    }

    .tab-content--https-functions td.log-entry-cell-level {
      min-width: 4rem;
    }
  </style>
</head>

<body>
  <div class="super-container">
    <div class="tabs">
      <ul>
        <li class="tab--dashboard is-active" onclick="openTab('dashboard')">
          <a>
            <span class="icon is-small"><i class="fas fa-home" aria-hidden="true"></i></span>
            <span title="Dashboard">Dashboard</span>
          </a>
        </li>
        <li class="tab--https-functions" onclick="openTab('https-functions')">
          <a title="HTTPS Functions">HTTPS Functions</a>
        </li>
        <li class="tab--callable-functions" onclick="openTab('callable-functions')">
          <a title="Callable Functions">Callable Functions</a>
        </li>
        <li class="tab--firestore" onclick="openTab('firestore')">
          <a title="Firestore">Firestore</a>
        </li>
      </ul>
    </div>

    <div class="tab-content tab-content--dashboard is-active">
      <div class="level top-controls">
        <div class="field is-horizontal">
          <div class="field-body">
            <div class="field has-addons">
              <p class="control">
                <a class="button is-static">
                  Project:
                </a>
              </p>
              <div class="select">
                <select class="project-selector"></select>
              </div>
            </div>
            <div class="field has-addons workspace-selector-field hidden">
              <p class="control">
                <a class="button is-static">
                  Workspace:
                </a>
              </p>
              <p class="control">
                <div class="select">
                  <select class="workspace-selector"></select>
                </div>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="columns bottom is-mobile is-variable is-2">
        <div class="column controls">

          <div class="box">
            <label class="label controls-box-label">
              Status: <span class="running-status"></span>
            </label>
            <div class="columns is-mobile is-variable is-3">
              <div class="column">
                <button class="button start" onclick="start()">Start</button>
              </div>
              <div class="column">
                <button class="button stop" onclick="stop()" disabled>Stop</button>
              </div>
            </div>
          </div>

          <div class="box">
            <label class="label controls-box-label">
              Enabled Emulators
            </label>
            <div class="field">
              <input type="checkbox" id="switch-emu-all" class="switch is-outlined"
                onchange="toggleAllEmulatorsSwitch(this.checked)" checked>
              <label class="checkbox" for="switch-emu-all">
                All
              </label>
            </div>
            <div class="field">
              <input type="checkbox" id="switch-emu-functions" class="switch is-outlined" checked disabled>
              <label class="checkbox" for="switch-emu-functions">
                Functions
              </label>
            </div>
            <div class="field">
              <input type="checkbox" id="switch-emu-firestore" class="switch is-outlined" checked disabled>
              <label class="checkbox" for="switch-emu-firestore">
                Firestore
              </label>
            </div>
            <div class="field">
              <input type="checkbox" id="switch-emu-database" class="switch is-outlined" checked disabled>
              <label class="checkbox" for="switch-emu-database">
                Database
              </label>
            </div>
            <div class="field">
              <input type="checkbox" id="switch-emu-hosting" class="switch is-outlined" checked disabled>
              <label class="checkbox" for="switch-emu-hosting">
                Hosting
              </label>
            </div>
          </div>

        </div>
        <div class="column">
          <div class="box shell-output-box terminal">
            <div class="shell-output terminal">
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content tab-content--https-functions">
      <table class="table logging-table is-fullwidth is-hoverable">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Type</th>
            <th>Level</th>
            <th>Text</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <!-- <div class="box shell-output-box terminal">
        <div class="shell-output terminal">
        </div>
      </div> -->
    </div>

    <div class="tab-content tab-content--callable-functions">
      callable-functions
    </div>

    <div class="tab-content tab-content--firestore">
      firestore
    </div>
  </div>
</body>
<script>
  // @ts-ignore
  const vscode = acquireVsCodeApi();
  const shellOutput = document.querySelector('.tab-content--dashboard .shell-output');
  const startButton = document.querySelector('.controls .button.start');
  const stopButton = document.querySelector('.controls .button.stop');
  const projectSelector = document.querySelector('.top-controls .project-selector');
  const workspaceSelector = document.querySelector('.top-controls .workspace-selector');

  window.addEventListener('message', ({ data }) => {
    switch (data.command) {
      case 'initialize':
        initialize(data);
        break;
      case 'stdout':
      case 'stderr':
        const shellMessage = document.createElement('div');
        shellMessage.classList.add('item', 'item-' + data.command);
        shellMessage.innerHTML = data.message;
        shellOutput.appendChild(shellMessage);
        break;
      case 'log':
        addLogEntry(data.message);
        break;
      case 'server-closed':
        stopped();
        break;
      case 'focus':
        // The windowebview got focus.
        break;
      default:
        console.error('Unknown command received:', data)
      // TODO: throw? ignore?
    }
  });

  vscode.postMessage({
    command: 'ready'
  });

  function start() {
    // @ts-ignore
    const [email, projectId] = projectSelector.options[projectSelector.selectedIndex].value.split('#');
    // @ts-ignore
    const path = workspaceSelector.options[workspaceSelector.selectedIndex].value;

    let emulators;
    const allEmulators = isSwitchEnabled('switch-emu-all');
    if (allEmulators) {
      emulators = 'all';
    } else {
      emulators = [];
      if (isSwitchEnabled('switch-emu-functions')) {
        emulators.push('functions');
      }
      if (isSwitchEnabled('switch-emu-firestore')) {
        emulators.push('firestore');
      }
      if (isSwitchEnabled('switch-emu-database')) {
        emulators.push('database');
      }
      if (isSwitchEnabled('switch-emu-hosting')) {
        emulators.push('hosting');
      }
    }


    vscode.postMessage({ command: 'start', email, projectId, path, emulators });
    startButton.setAttribute('disabled', 'disabled');
    stopButton.removeAttribute('disabled');
    document.body.classList.add('running');
  }

  function stop() {
    stopButton.classList.add('is-loading');
    stopButton.setAttribute('disabled', 'disabled');
    document.body.classList.remove('running');
    document.body.classList.add('stopping');
    vscode.postMessage({ command: 'stop' });
  }

  function stopped() {
    startButton.removeAttribute('disabled');
    stopButton.setAttribute('disabled', 'disabled');
    stopButton.classList.remove('is-loading');
    document.body.classList.remove('running');
    document.body.classList.remove('stopping');
  }

  function postMessage(message) {
    vscode.postMessage(message);
  }

  function initialize(data) {
    const {
      folders,
      accountsWithProjects,
      selectedAccountEmail,
      selectedProjectId
    } = data;

    const numAccounts = accountsWithProjects.length;

    accountsWithProjects.forEach(awp => {
      let parent;

      if (numAccounts > 1) {
        parent = document.createElement('optgroup');
        parent.setAttribute('label', awp.email);
      } else {
        parent = projectSelector;
      }

      awp.projects.forEach(project => {
        const option = document.createElement('option');
        option.innerText = project.displayName || project.projectId;
        option.setAttribute('value', awp.email + '#' + project.projectId);

        const isSelected =
          selectedAccountEmail === awp.email &&
          selectedProjectId === project.projectId

        if (isSelected) {
          option.setAttribute('selected', 'selected');
        }

        parent.appendChild(option);
      });

      if (numAccounts > 1) {
        projectSelector.appendChild(parent);
      }
    });


    folders.forEach(folder => {
      const option = document.createElement('option');
      option.innerText = folder.name;
      option.setAttribute('value', folder.path);
      workspaceSelector.appendChild(option);
    });

    if (folders.length > 1) {
      const field = document.querySelector('.top-controls .workspace-selector-field');
      field.classList.remove('hidden');
    }
  }

  function isSwitchEnabled(id) {
    const elem = document.querySelector('#' + id);
    // @ts-ignore
    return elem.checked;
  }

  function toggleAllEmulatorsSwitch(isChecked) {
    const disabled = isChecked ? 'disabled' : null;
    const elements = ['functions', 'firestore', 'database', 'hosting'].forEach(
      service => {
        const element = document.querySelector('#switch-emu-' + service);
        if (isChecked) {
          element.setAttribute('disabled', 'disabled');
        } else {
          element.removeAttribute('disabled');
        }
      }
    );
  }

  function openTab(tabName) {
    const tabs = document.querySelectorAll(".tabs li");
    tabs.forEach(tab => {
      const isSelected = tab.classList.contains('tab--' + tabName);
      if (isSelected) {
        tab.classList.add('is-active');
      } else {
        tab.classList.remove('is-active');
      }
    });

    const contents = document.querySelectorAll(".tab-content");
    contents.forEach(tabContent => {
      const isSelected = tabContent.classList.contains('tab-content--' + tabName);
      if (isSelected) {
        tabContent.classList.add('is-active');
      } else {
        tabContent.classList.remove('is-active');
      }
    });
  }

  function addLogEntry(entry) {
    console.log(entry);
    const output = document.querySelector('.tab-content--https-functions table tbody');
    const row = document.createElement('tr');

    row.classList.add(
      'log-entry',
      'log-entry-type--' + entry.type,
      'log-entry-level--' + entry.level
    );

    ['timestamp', 'type', 'level', 'text'].forEach(field => {
      const cell = document.createElement('td');
      cell.classList.add('log-entry-cell', 'log-entry-cell-' + field);

      let value = entry[field] || '';

      if (value && field === 'timestamp') {
        const date = new Date(value);
        value = date.toLocaleDateString(undefined, {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric'
        });
      }

      cell.innerText = value;
      row.appendChild(cell);
    });

    output.appendChild(row);

  }
</script>

</html>